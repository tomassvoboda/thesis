\chapter{Eggan's question}

In this chapter we present an answer to the question whether there are rational languages with arbitrarily large star heights. The first examples of those languages are given by~\cite{Eggan63}. \X{Should this also be a citation?$\to$} Eggan's examples use an~alphabet of size $2^n - 1$ for the language with star height $n$. He therefore asked whether there are some examples of languages over binary alphabets. Answer to that question, which is affirmative, was provided shortly after by~\cite{DejeanSchutzenberger66}. Their answer is also reformulated by~\cite{Sakarovitch09}, which \X{or who? (Book provided, or person provided?)} provided a basis for this work.

Throughout this chapter we use language $W_q = {\{f \mid |f|_a \equiv |f|_b \pmod{2^q} \}}$. \X{Move this into a special Definition?}

\begin{thm}\label{thm:main}
    The language $W_q$ has star height~$q$.
\end{thm}

The proof has two parts. First we find a~rational expression of star height~$q$, denoting $W_q$, and then we show that the star height of the language has to be at~least $q$. The first part is done as proof of Lemma~\ref*{lm:expression_existence}, which leaves the second part to be done in the Proof of~\autoref*{thm:main}.

\begin{lemma}\label{lm:expression_existence}
    Language $W_q$ is denoted by a rational expression of star height $q$.
\end{lemma}

\begin{proof}
    $W_q$ is recognised by an automaton~${\mathcal{R}(2^q)}$. The rational expression of star height $q$ will be obtained by applying the state removal algorithm on~${\mathcal{R}(2^q)}$. That means that the only transition left in the final automaton will be labelled by the desired rational expression. First we inductively define the following rational expressions:
    \begin{align*}
        \re{X}_0 &= a, & \re{Y}_0 &= b, & &\text{ and } & \re{Z}_0 &= 0, \\
        \re{X}_1 &= a^2, & \re{Y}_1 &= b^2, & &\text{ and } & \re{Z}_1 &= ab+ba, \\
        &\; \vdots & &\; \vdots & & & &\; \vdots \\
        \re{X}_{n+1} &= \re{X}_n \re{Z}_n^* \re{X}_n, & \re{Y}_{n+1} &= \re{Y}_n \re{Z}_n^* \re{Y}_n, & &\text{ and } & \re{Z}_{n+1} &= \re{Z}_n + \re{X}_n \re{Z}_n^* \re{Y}_n + \re{Y}_n \re{Z}_n^* \re{X}_n.
    \end{align*}

    Next, we look at constructing an~automaton, which we will call ${\mathcal{R}(2^q)}_0$, from ${\mathcal{R}(2^q)}$. The construction is shown in~\autoref*{fig:construction_of_R2q_0}. Every transition labelled~$a$ is replaced by one labelled $\re{X}_0$, every transition labelled~$b$ is replaced by one labelled $\re{Y}_0$, and a~loop labelled $\re{Z}_0$ is added to every state. Finally, we add two new distinct states $i$ and $t$, and related spontaneous transitions, in the same way as in the beginning of the state removal algorithm. It is clear, that ${\mathcal{R}(2^q)}_0$ accepts the same language as ${\mathcal{R}(2^q)}$.

    \begin{figure}[h]%
        \centering
        \subfloat[An automaton~${\mathcal{R}(2^q)}$]{%
            \input{./figures/automaton_R2q}}%
        \hspace{60pt}%
        \subfloat[An automaton~${\mathcal{R}(2^q)}_0$]{%
            \input{./figures/automaton_R2q_0}}
        \caption{Construction of ${\mathcal{R}(2^q)}_0$ from ${\mathcal{R}(2^q)}$}\label{fig:construction_of_R2q_0}%
    \end{figure}

    This phase of the proof has $q-2$ steps. In each step $i$, for $1 \leq i \leq q-2$, we construct ${\mathcal{R}(2^q)}_i$ from ${\mathcal{R}(2^q)}_{i-1}$ without changing the recognised language. Each step $i$ of this phase comprises of $2^{q-i}$ steps of the state removal algorithm. The states removed are all the odd states of the ${\mathcal{R}(2^q)}_{i-1}$ automaton. That means that if ${\mathcal{R}(2^q)}$ has $2^q$ states, then ${\mathcal{R}(2^q)}_0$ has $2^q + 2$ states, ${\mathcal{R}(2^q)}_1$ has $2^{q-1} + 2$ states, and so on, which leaves the automaton produced by the last step of this phase, ${\mathcal{R}(2^q)}_{q-2}$, with $2^{q-(q-2)} + 2 = 6$ states. After the removal of the $2^{q-i}$ odd states, the remaining $2^{q-i}$ even states, that is excluding the two special states~$i$, and~$t$, are renamed as members of $\Z_{2^{q-i}}$. \autoref*{fig:construction_of_R2q_i} illustrates the $i$th step of this phase.

    \begin{figure}[h]%
        \centerline{
            \hspace{-25pt}%
            \subfloat[An automaton~${\mathcal{R}(2^q)}_{i-1}$]{%
                \input{./figures/automaton_R2q_i-1}}%
            \quad
            \subfloat[${\mathcal{R}(2^q)}_{i-1}$ after $2^{q-i}$ steps of the state removal algorithm]{\label{fig:odd_states_removed}%
                \input{./figures/automaton_R2q_i_before_renaming}}
            \quad
            \subfloat[Automaton from figure~\ref*{fig:odd_states_removed} with renamed states, which is an automaton~${\mathcal{R}(2^q)}_i$]{%
                \input{./figures/automaton_R2q_i}}%
        }
        \caption{Construction of ${\mathcal{R}(2^q)}_i$ from ${\mathcal{R}(2^q)}_{i-1}$\\ \X{Can the image overflow the text margins?}}\label{fig:construction_of_R2q_i}%
    \end{figure}

    The result of the $q-2$ steps described above is an automaton~${\mathcal{R}(2^q)}_{q-2}$, shown in Figure~\ref*{fig:automaton_R2q_q-2}. ${\mathcal{R}(2^q)}_{q-1}$ is clearly a result of the states $1$, and $3$ being removed from the automaton~${\mathcal{R}(2^q)}_{q-2}$ by the state removal algorithm. The equivalence
    \[
        {(\re{Z}_{q-1} + {(\re{X}_{q-1} + \re{Y}_{q-1})}\re{Z}_{q-1}^*{(\re{X}_{q-1} + \re{Y}_{q-1})})}^* = {(\re{X}_q + \re{Y}_q + \re{Z}_q)}^*
    \]
    shows, that after applying the state removal algorithm on the state $1$ of ${\mathcal{R}(2^q)}_{q-1}$, we get ${\mathcal{R}(2^q)}_{q}$. These two last steps are shown in the~\autoref*{fig:construction_of_R2q_q}.

    \begin{figure}[h]%
        \centerline{
            \hspace{-25pt}%
            \subfloat[An automaton~${\mathcal{R}(2^q)}_{q-2}$]{\label{fig:automaton_R2q_q-2}%
                \input{./figures/automaton_R2q_q-2}}%
            \quad
            \subfloat[An automaton~${\mathcal{R}(2^q)}_{q-1}$]{%
                \input{./figures/automaton_R2q_q-1}}%
            \quad
            \subfloat[An automaton~${\mathcal{R}(2^q)}_{q}$]{%
                \input{./figures/automaton_R2q_q}}%
        }
        \caption{Steps $q-2, \: q-1$, and $q$ of the construction of ${\mathcal{R}(2^q)}_q$\\ \X{Fix the vertical space of the subfigures!}}\label{fig:construction_of_R2q_q}%
    \end{figure}

    Each of the rational expressions $\re{X}_q, \re{Y}_q$, and $\re{Z}_q$ has star height of $q-1$, therefore ${(\re{X}_q + \re{Y}_q + \re{Z}_q)}^*$ has star height of $q$. Since none of the automaton constructions changed the recognised language, it follows that $W_q$ is denoted by ${(\re{X}_q + \re{Y}_q + \re{Z}_q)}^*$.
\end{proof}

\begin{example}
    According to the procedure described in the Proof of~Lemma~\ref*{lm:expression_existence}, we apply the state removal algorithm on the automaton~${\mathcal{R}(8)}$, recognising language~$W_3$. The steps of the creation of rational expression ${(\re{X}_3 + \re{Y}_3 + \re{Z}_3)}^*$, denoting $W_3$, are shown in~\autoref*{fig:automaton_R8_state_removal_steps}.

    \begin{figure}[h]%
        \centerline{
            \hspace{-15mm}%
            \subfloat[An automaton~${\mathcal{R}(8)}$]{%
                \input{./figures/automaton_R8}}%
            \qquad
            \subfloat[An automaton~${\mathcal{R}(8)}_0$]{%
                \input{./figures/automaton_R8_0}}%
            \qquad
            \subfloat[]{%
                \input{./figures/automaton_R8_0_removed1}}
        }
        \vspace{5mm}
        \centerline{
            \hspace{-15mm}%
            \subfloat[]{%
                \input{./figures/automaton_R8_0_removed2}}%
            \quad
            \subfloat[]{%
                \input{./figures/automaton_R8_0_removed3}}
            \quad
            \subfloat[An automaton~${\mathcal{R}(8)}_1$]{%
                \input{./figures/automaton_R8_1}}
        }
        \vspace{5mm}
        \centerline{
            \hspace{-15mm}%
            \subfloat[]{%
                \input{./figures/automaton_R8_1_removed1}}%
            \quad
            \subfloat[An automaton~${\mathcal{R}(8)}_2$]{%
                \input{./figures/automaton_R8_2}}
            \quad
            \subfloat[An automaton~${\mathcal{R}(8)}_3$]{%
                \input{./figures/automaton_R8_3}}
        }
        \caption{Steps of the state removal algorithm on $\aut{R}(8)$ executed in the order described in the Proof of~Lemma~\ref*{lm:expression_existence}}\label{fig:automaton_R8_state_removal_steps}%
    \end{figure}
\end{example}

We have found a~rational expression of star height $q$ denoting the language $W_q$, which means that the star height of the language will not be higher then $q$. We proceed to show that it also has to be at least $q$. First let us present a few definitions and observe some of their properties that will be useful to us later.

\begin{defn}
    For~each integer~$n$ we define the~sequence $w_{0,n}, w_{1,n}, \dotsc , w_{q-1,n}$ of $q$~words in~$W_q$ recursively:
    \begin{alignat*}{2}
        w_{0,n} &= ab,\\
        w_{1,n} &= a^2{(ab)}^{n}b^2{(ab)}^{n},\\
                &\; \vdots \\
        w_{k,n} &= a^{2^k}{(w_{k-1,n})}^{n}b^{2^k}{(w_{k-1,n})}^{n},\\
                &\; \vdots \\
        w_{q-1,n} &= a^{2^{q-1}}{(w_{q-2,n})}^{n}b^{2^{q-1}}{(w_{q-2,n})}^{n}.
    \end{alignat*}
    We call these words \emph{witness words}.
\end{defn}

\begin{lemma}\label{lm:witness_words_inequalities}
    Any left factor $u$ and right factor $v$ of ${(w_{k,n})}^n$ satisfy the equations:
    \begin{equation}
        0 \leq |u|_a - |u|_b \leq 2^{k+1}-1 \; , \qquad 0 \leq |v|_b - |v|_a \leq 2^{k+1}-1.
    \end{equation}
\end{lemma}

\begin{proof}
    We immediately see that $|w_{k,n}|_a = |w_{k,n}|_b$, therefore any whole word $w_{k,n}$ that is a factor of either $u$ or $v$ does not affect the inequalities we are trying to prove. We only need to examine the differences in the frequency of letters of the left, or~right, factor of the word $w_{k,n}$. We proceed by induction on~$k$. Trivially the inequalities hold for $w_{0,n}$. The word
    \[
        w_{k,n} = a^{2^k}{(w_{k-1,n})}^{n}b^{2^k}{(w_{k-1,n})}^{n}
    \] begins with $2^k$ $a$'s and from the induction hypothesis, we know that $w_{k-1,n}$ can have at most $2^k-1$ more $a$'s than $b$'s. We can also see that in the left factor $u$ there is always at least as many $a$'s as there is $b$'s. That proves the inequalities fot the left factor.

    Similarly we prove the case for the right factor $v$. From the induction hypothesis we know that the right factor of $w_{k-1,n}$ can have at most $2^k-1$ more $b$'s than $a$'s. Therefore if $b^{2^k}{(w_{k-1,n})}^{n}$ is a right factor of $v$, we can assume that the right factor of ${(w_{k-1,n})}^{n}$ is the left factor of $v$. From this fallows, that $|v|_b - |v|_a \leq 2^k + 2^k -1$. The fact, that there is at least as many $b$'s as there is $a$'s in the right factor $v$ is obvious.
\end{proof}

Next we use the witness words to define a property of languages.

\begin{defn}
    We say that language $L$ \emph{satisfies property $P_k$} if there exists an infinite number of values of $n$ such that ${(w_{k,n})}^n$ is a~factor of at~least one word in~L.
\end{defn}

Note that if $L$ satisfies $P_k$, it also satisfies $P_l$ for $l < k$ since ${(w_{l,n})}^n$ is a~factor of ${(w_{k,n})}^n$.

\begin{proof}[Proof of \autoref*{thm:main}]
    Lemma~\ref*{lm:expression_existence} shows that the star height of $W_q$ is at~most~$q$. Now we show that it also has to be at~least~$q$.

    By $\mathfrak{W}_k$ we denote a family of languages $L$ that satisfy the following conditions:
    \begin{itemize}
        \item[(i)] $L \subseteq W_q$,
        \item[(ii)] $L$ satisfies $P_k$,
        \item[(iii)] $L$ has a minimum star height of any language satisfying the first two conditions.
    \end{itemize}

    Let $h_k$ be the common value of the star height of the languages in $\mathfrak{W}_k$. Languages in $\mathfrak{W}_0$ are necessarily infinite, therefore $0 < h_0$. $P_k$ implies $P_{k-1}$, which means that \X{(Probably not true.) $\mathfrak{W}_k \subseteq \mathfrak{W}_{k-1}$, and} $h_{k-1} \leq h_k$. $W_q$ obviously satisfies (i). It also satisfies $P_{q-1}$ since $|{(w_{q-1,n})}^n|_a = |{(w_{q-1,n})}^n|_b$ for each $n$. Because we have found a~rational expression of star height $q$ denoting $W_q$, it follows that $h_{q-1} \leq q$. Therefore we have
    \[
        0 < h_0 \leq h_1 \leq \dotsb \leq h_{q-1} \leq q.
    \]

    To prove the theorem it is enough to show that $h_{k-1} < h_k$ for each $k$, $k=1, \dotsc, q-1$. Let $L$ be in $\mathfrak{W}_k$. Due to Lemma~\ref*{lm:star_height_distributivity} $L$ can be written as a finite union of languages $E_j$, each denoted by a~rational expression of the form
    \[
        \re{E}_j = u_0{(\re{H}_1)}^*u_1 \dotsm u_{m-1}{(\re{H}_m)}^*u_m,
    \]
    where each rational expression $\re{H}_i$ denotes a~language~$H_i$ with star height less then or equal to $h_k-1$. Since $L$ satisfies $P_k$ and the union of the languages $E_j$ is finite, it follows that at least one of $E_j$ has to satisfy $P_k$. We can therefore safely assume that $L$ itself is denoted by a~rational expression of the same form as $E_j$.

    For each word $g$ in $H_i$, words $u_0 u_1 \dotsm u_m$ and $u_0 u_1 \dotsm u_{i-1} g u_i \dotsm u_m$ are both in language $L$. Therefore, because it has to be true that $|g|_a \equiv |g|_b \pmod{2^q}$, $H_i \subseteq W_q$.

    Since $L$ is of a minimal star height to satisfy $P_k$, none of the $H_i$ satisfies $P_k$. Now we need to show that some $H_i$ satisfies $P_{k-1}$. As a matter of fact, we will have $h_{k-1} \leq h_k - 1$.

    $L$ satisfies $P_k$, therefore words ${(w_{k,n})}^n$ are factors of~$L$ for arbitrarily large $n$. Lemma~\ref*{lm:block_star_lemma} shows that we can find $N$ large enough, such that there is infinitely many $n' \geq N$, that ${(w_{k,n'})}^{n'}$ is a factor of $L$, and, for each $n'$, we have infinitely many $l$'s, that ${(w_{k,n'})}^l$ is a factor of $L$.

    Let $H_i^*$ be the language recognised by $\re{H}_i^*$. Since $m$ is finite and fixed for $L$, there has to be infinitely many $n$'s, that ${(w_{k,n})}^n$ is a factor of $r_n \in H_i^*$ for some~$i$, $1 \leq i \leq m$. This means that $H_i^*$ satisfies $P_k$. Next we show that for these $n$'s, ${(w_{k-1,n})}^n$ is a factor of a word in $H_i$, meaning $H_i$ satisfies $P_{k-1}$.

    We write $r_n$ as a factorisation $r_n = g_0 g_1 \dotsm g_l$, where $g_j \in H_i$, for $0 \leq j \leq l$. If $w_{k,n}$, from ${(w_{k,n})}^n$, is a factor of some $g_j$, the condition is satisfied, since ${(w_{k-1,n})}^n$ is a factor of $w_{k,n}$. Otherwise, let us show how a~factor ${(w_{k,n})}^2$ is covered by the factorisation of $r_n$. Written explicitly, we have
    \[
        {(w_{k,n})}^2 = a^{2^k}{(w_{k-1,n})}^{n}b^{2^k}{(w_{k-1,n})}^{n}a^{2^k}{(w_{k-1,n})}^{n}b^{2^k}{(w_{k-1,n})}^{n}.
    \]
    Let us consider the $g_j$ that covers, at least partially, the factor $b^{2^k}$. There are two possibilities:
    \begin{itemize}
        \item[(i)] $b^{2^k}$ is a factor of $g_j$,
        \item[(ii)] a left factor of $b^{2^k}$ is a right factor of $g_j$.
    \end{itemize}

    In case (i), we have $g_j = v b^{2^k} u$. If $v$ covers the factor ${(w_{k-1,n})}^{n}$ to the left of $b^{2^k}$, or $u$ covers the factor ${(w_{k-1,n})}^{n}$ to the right of $b^{2^k}$, the condition is satisfied. If not, $u$ is a left factor of ${(w_{k-1,n})}^{n}$ and $v$ is a right factor. Set
    \[
        x = |g_j|_b - |g_j|_a, \quad y = |u|_a - |u|_b, \quad \text{ and } \quad z = |v|_b - |v|_a.
    \]
    Hence
    \[
        x = 2^k - (y - z).
    \]
    We see that $1 - 2^k \leq y - z \leq 2^k - 1$, from Lemma~\ref*{lm:witness_words_inequalities}. That gives us
    \[
        0 < x < 2^{k+1} \leq 2^q.
    \]
    which contradicts the fact that $g_j \in H_i \subseteq W_q$.

    In case (ii), we have $g_j = v b^{r}, \: 0 < r < 2^k$. If ${(w_{k-1,n})}^{n}$ is a factor of $v$, the condition is satisfied. Otherwise $v$ is a right factor of ${(w_{k-1,n})}^{n}$ and, similarly as above, we set
    \[
        x = |g_j|_b - |g_j|_a, \quad \text{ and } \quad z = |v|_b - |v|_a.
    \]
    Hence
    \[
        x = r + z.
    \]
    Therefore, due to Lemma~\ref*{lm:witness_words_inequalities},
    \[
        r \leq x \leq r + 2^k - 1 < 2^{k+1} \leq 2^q.
    \]
    which produces the same contradiction as the case (i).
\end{proof}